const tg = window.Telegram.WebApp;
tg.expand();
tg.enableClosingConfirmation();

// –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
const balanceElement = document.getElementById('balance');
const playerCardsElement = document.getElementById('playerCards');
const communityCardsElement = document.getElementById('communityCards');
const statusElement = document.getElementById('status');
const potElement = document.getElementById('pot');

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
let currentTableId = null;
let currentUserId = null;
let gameState = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
window.onload = async () => {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = tg.initDataUnsafe.user;
    currentUserId = user.id;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    balanceElement.innerText = `–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è @${user.username}...`;
    statusElement.innerText = "–û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ —Å—Ç–æ–ª—É";
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞
    const tableId = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–≤–æ–≥–æ —Å—Ç–æ–ª–∞:");
    if (tableId && !isNaN(tableId)) {
        joinTable(parseInt(tableId));
    } else {
        statusElement.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.";
    }
};

// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —Å—Ç–æ–ª—É
async function joinTable(tableId) {
    currentTableId = tableId;
    statusElement.innerText = `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ —Å—Ç–æ–ª—É #${tableId}...`;
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        const response = await fetch(`/api/join_table/${tableId}/${currentUserId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
        });
        
        const result = await response.json();
        if (result.success) {
            statusElement.innerText = `–í—ã –∑–∞ —Å—Ç–æ–ª–æ–º #${tableId}. –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã...`;
            startGameLoop();
        } else {
            statusElement.innerText = `–û—à–∏–±–∫–∞: ${result.message}`;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
        statusElement.innerText = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º";
    }
}

// –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
async function startGameLoop() {
    while (currentTableId) {
        try {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            const response = await fetch(`/api/table/${currentTableId}/${currentUserId}`);
            const data = await response.json();
            
            if (data.error) {
                statusElement.innerText = data.error;
                break;
            }
            
            gameState = data;
            updateGameUI();
            
            // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            await new Promise(resolve => setTimeout(resolve, 3000));
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
            statusElement.innerText = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º";
            break;
        }
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
function updateGameUI() {
    if (!gameState) return;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
    const playerData = gameState.players[currentUserId];
    if (playerData) {
        balanceElement.innerText = `üí∞ –ë–∞–ª–∞–Ω—Å: ${playerData.chips} —Ñ–∏—à–µ–∫`;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç –∏–≥—Ä–æ–∫–∞
    playerCardsElement.innerHTML = '';
    if (playerData && playerData.cards) {
        playerData.cards.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            cardElement.textContent = card;
            playerCardsElement.appendChild(cardElement);
        });
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–∏—Ö –∫–∞—Ä—Ç
    communityCardsElement.innerHTML = '';
    if (gameState.community_cards) {
        gameState.community_cards.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            cardElement.textContent = card;
            communityCardsElement.appendChild(cardElement);
        });
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–Ω–∫–∞
    potElement.innerText = `üèÜ –ë–∞–Ω–∫: ${gameState.pot} —Ñ–∏—à–µ–∫`;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    if (gameState.current_player === currentUserId) {
        statusElement.innerText = '‚≠ê –í–ê–® –•–û–î!';
        enableButtons(true);
    } else {
        statusElement.innerText = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞ –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞...';
        enableButtons(false);
    }
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–∑–µ –∏–≥—Ä—ã
    const phaseNames = {
        'waiting': '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤',
        'preflop': '–ü—Ä–µ—Ñ–ª–æ–ø',
        'flop': '–§–ª–æ–ø',
        'turn': '–¢–µ—Ä–Ω',
        'river': '–†–∏–≤–µ—Ä',
        'showdown': '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è'
    };
    document.getElementById('phase').innerText = `–§–∞–∑–∞: ${phaseNames[gameState.phase]}`;
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
function enableButtons(enabled) {
    document.querySelectorAll('button').forEach(btn => {
        btn.disabled = !enabled;
    });
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
async function sendAction(action, amount = 0) {
    if (!currentTableId) return;
    
    try {
        const response = await fetch(`/api/action/${currentTableId}/${currentUserId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action, amount })
        });
        
        const result = await response.json();
        if (!result.success) {
            tg.showPopup({
                title: '–û—à–∏–±–∫–∞',
                message: result.message,
                buttons: [{ type: 'ok' }]
            });
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è:', error);
        tg.showPopup({
            title: '–û—à–∏–±–∫–∞',
            message: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ',
            buttons: [{ type: 'ok' }]
        });
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
document.getElementById('checkBtn').addEventListener('click', () => sendAction('check'));
document.getElementById('foldBtn').addEventListener('click', () => sendAction('fold'));
document.getElementById('callBtn').addEventListener('click', () => sendAction('call'));
document.getElementById('raiseBtn').addEventListener('click', () => {
    const amount = parseInt(prompt('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–≤—ã—à–µ–Ω–∏—è:'));
    if (!isNaN(amount)) {
        sendAction('raise', amount);
    }
});
